---
title: R√©gnez sur vos APIs avec Kong
date: "2017-02-11T12:00:00.000Z"
description: Mise en place d‚Äôune solution d‚ÄôAPI Management dans votre infrastructure
template: "post"
draft: false
slug: "kong"
category: "Dev"
language: üá´üá∑
tags:
  - "API"
  - "API Management"
  - "Docker"
  - "Architecture"
socialImage: "/media/kong.jpg"
---

[Mashape](https://www.mashape.com/) est un catalogue public d‚ÄôAPI, permettant √† ses utilisateurs de partager ses APIs ou d‚Äôutiliser celle des autres. Afin de s√©curiser et g√©rer ces quelques 15000 micro-services pr√©sents dans leur catalogue, Mashape a cr√©e [Kong](https://getkong.org/), une solution d‚ÄôAPI management.

Kong est une solution open-source bas√©e sur NGinx, qui permet de r√©pondre aux contraintes des milliards de requ√™tes par mois que doit g√©rer Mashape.

![](/media/kong/modules.png)

Kong s‚Äôappuie √©galement sur une base de donn√©es Cassandra (possibilit√© d‚Äôutiliser PostgreSQL), ainsi que sur un ensemble de plug-ins. Par d√©faut, la solution offre d√©j√† un socle de modules permettant l‚Äôauthentification, la s√©curit√©, le rate-limiting ou encore la supervision. Il vous sera √©galement possible si besoin de cr√©er vos propres plug-in (cf. [la documentation officielle](https://getkong.org/plugins/)) 

Dans votre infrastructure, l‚ÄôAPI manager se place en amont des services √† exposer (approche reverse-proxy), et prendra en charge les fonctionnalit√©s que vous lui d√©l√©guez. D√®s lors, chacun de vos services m√©tiers n‚Äôaura plus √† g√©rer ces taches techniques et pourra se concentrer sur son coeur m√©tier.

![](/media/kong/archi-wo-kong.png)

![Architecture Legacy vs. Architecture orient√©e API](/media/kong/archi-w-kong.png)*Architecture Legacy vs. Architecture orient√©e API*

Alors, que vous deviez g√©rer un ensemble de micro-services, une API qui commence √† devenir populaire ou simplement un backend web/mobile, il est peut-√™tre temps de commencer √† g√©rer vos APIs.

## Getting started

Dans cette partie, nous utiliserons comme API partenaire celle expos√©e par le site [http://anapioficeandfire.com/](http://anapioficeandfire.com/) et qui expose les donn√©es relatives √† l‚Äôunivers de Game of Thrones.

Pour d√©ployer Kong, nous utiliserons des conteneurs Docker *orchestr√©s* par docker-compose. La configuration de la stack est la suivante :

`gist:d3rwan/011f9875f4cc3a11fd83860e0a9486f9#docker-compose.yml`

* D√©marrer la stack

Depuis le r√©pertoire contenant le fichier docker-compose.yml d√©crit pr√©c√©demment
```
    # run (daemon)
    docker-compose up -d
    # show logs
    docker-compose logs -f
```
Une fois la stack d√©marr√©e, nous pouvons acc√©der √† ses diff√©rents composants

> localhost si vous utilisez Docker sous Mac ou Linux, l‚Äôadresse de docker-machine sinon

* API Manager - localhost**:8001
    * API gr√¢ce √† laquelle nous allons administrer Kong

* API Gateway - localhost**:8000
    * API gr√¢ce √† laquelle nous acc√©derons √† nos API

* Kong Dashboard - localhost**:8080** 
    * IHM open-source qui utilise l‚ÄôAPI d‚Äôadministration afin d‚Äôoffrir une interface d‚Äôadministration

A pr√©sent, nous allons pouvoir utiliser notre API manager.

> Dans la suite de l‚Äôarticle, nous directement l‚ÄôAPI via des appels REST, mais nous pourrions √©galement utiliser l‚ÄôIHM de Kong Dashboard pour configurer Kong

## How to

### Cr√©er une API

    curl -i -X POST http://localhost:8001/apis/ \
     --data 'name=GOT' \
     --data 'upstream_url=http://anapioficeandfire.com/api/' \
     --data 'request_path=/got/' \
     --data 'preserve_host=false'\
     --data 'strip_request_path=true'

On cr√©e une API qu‚Äôon appelle *GOT* et qui pointe vers notre API partenaire, sur le path */got/* de notre API gateway. On peut d√©sormais y acc√©der via l‚ÄôAPI gateway

    curl -i -X GET http://localhost:8000/got/characters/583

### Activer l‚Äôauthentification

    curl -i -X POST http://localhost:8001/apis/GOT/plugins/ \
      --data 'name=key-auth' \
      --data 'config.key_names=apiKey'

On associe le plugin [key-auth](https://getkong.org/plugins/key-authentication/) de Kong √† notre API qui ne sera donc plus accessible sans token d‚Äôauthentification

    curl -i -X GET http://localhost:8000/got/characters/583

### Ajouter un utilisateur

    curl -i -X POST http://localhost:8001/consumers/ \
      --data "username=erwan"

### Autoriser ce nouvel utilisateur √† acc√©der √† l‚ÄôAPI

    curl -i -X POST http://localhost:8001/consumers/erwan/key-auth \
      --data "key=secret"

Notre API est donc bien s√©curis√©e, et seulement accessible avec la cl√© d‚Äôauthentification

    curl -i -X GET [http://localhost:8000/got/characters/583](http://localhost:8000/got/characters/583)
    curl -i -X GET [http://localhost:8000/got/characters/583](http://localhost:8000/got/characters/583)?apiKey=secret

### Activer le [rate-limiting](https://getkong.org/plugins/rate-limiting/)

    curl -X POST  http://localhost:8001/apis/GOT/plugins \
      --data "name=rate-limiting" \
      --data "config.hour=2"

Notre API est √† pr√©sent limit√©e √† 2 appels par heure.

    curl -i -X GET http://localhost:8000/got/characters/583?apiKey=secret
    curl -i -X GET http://localhost:8000/got/characters/583?apiKey=secret
    curl -i -X GET http://localhost:8000/got/characters/583?apiKey=secret

L‚Äôacc√®s √† notre API peut √† pr√©sent se faire via notre API manager apr√®s seulement quelques minutes de configuration. Gr√¢ce √† Kong, on pourra par la suite ajouter des contraintes d‚Äôacc√®s, des r√®gles de r√©√©criture de requ√™tes ou encore du monitoring sans devoir modifier notre coeur m√©tier, ou demander √† nos partenaires de le faire.

N‚Äôh√©sitez pas non plus √† parcourir le site de Kong, et sa documentation plut√¥t compl√®te pour voir tout ce qu‚Äôil pourrait faire pour vous.

[Site officiel - https://getkong.org/](https://getkong.org/)

Par ailleurs, vous pourrez retrouver la configuration d√©crite pr√©c√©demnt directement [sur ce repo github](https://github.com/d3rwan/kong_docker_stack)

Et devenez le *king* de vos API‚Äôs!


